import React, { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { format } from 'date-fns';

import NextPrayerBanner from '@/components/prayer/NextPrayerBanner';
import PrayerTimesCard from '@/components/prayer/PrayerTimesCard';
import QiblaCompass from '@/components/prayer/QiblaCompass';
import DailyDuaCard from '@/components/prayer/DailyDuaCard';
import IslamicDateCard from '@/components/prayer/IslamicDateCard';
import WeeklyProgress from '@/components/prayer/WeeklyProgress';

export default function Home() {
  const [prayerTimes, setPrayerTimes] = useState({});
  const [currentPrayer, setCurrentPrayer] = useState(null);
  const [nextPrayer, setNextPrayer] = useState(null);
  const [loading, setLoading] = useState(true);
  const queryClient = useQueryClient();

  const today = format(new Date(), 'yyyy-MM-dd');

  // Fetch prayer logs for today
  const { data: prayerLogs = [] } = useQuery({
    queryKey: ['prayerLogs', today],
    queryFn: () => base44.entities.PrayerLog.filter({ date: today }),
  });

  // Create prayer log mutation
  const createLogMutation = useMutation({
    mutationFn: (data) => base44.entities.PrayerLog.create(data),
    onSuccess: () => queryClient.invalidateQueries(['prayerLogs']),
  });

  // Update prayer log mutation
  const updateLogMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.PrayerLog.update(id, data),
    onSuccess: () => queryClient.invalidateQueries(['prayerLogs']),
  });

  // Convert prayer logs to a map for easier access
  const prayerLogsMap = prayerLogs.reduce((acc, log) => {
    acc[log.prayer_name] = log.completed;
    return acc;
  }, {});

  // Fetch prayer times based on location
  useEffect(() => {
    const fetchPrayerTimes = async () => {
      try {
        // Try to get user's location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const { latitude, longitude } = position.coords;
              
              // Use Aladhan API for prayer times
              const response = await fetch(
                `https://api.aladhan.com/v1/timings/${Math.floor(Date.now() / 1000)}?latitude=${latitude}&longitude=${longitude}&method=2`
              );
              const data = await response.json();
              
              if (data.data && data.data.timings) {
                const timings = data.data.timings;
                setPrayerTimes({
                  fajr: timings.Fajr,
                  dhuhr: timings.Dhuhr,
                  asr: timings.Asr,
                  maghrib: timings.Maghrib,
                  isha: timings.Isha
                });
              }
              setLoading(false);
            },
            () => {
              // Fallback to default times (Mecca)
              setDefaultPrayerTimes();
            }
          );
        } else {
          setDefaultPrayerTimes();
        }
      } catch (error) {
        setDefaultPrayerTimes();
      }
    };

    const setDefaultPrayerTimes = async () => {
      // Default to Mecca times
      const response = await fetch(
        `https://api.aladhan.com/v1/timings/${Math.floor(Date.now() / 1000)}?latitude=21.4225&longitude=39.8262&method=4`
      );
      const data = await response.json();
      
      if (data.data && data.data.timings) {
        const timings = data.data.timings;
        setPrayerTimes({
          fajr: timings.Fajr,
          dhuhr: timings.Dhuhr,
          asr: timings.Asr,
          maghrib: timings.Maghrib,
          isha: timings.Isha
        });
      }
      setLoading(false);
    };

    fetchPrayerTimes();
  }, []);

  // Determine current and next prayer
  useEffect(() => {
    const updateCurrentPrayer = () => {
      if (Object.keys(prayerTimes).length === 0) return;

      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();

      const prayerOrder = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
      
      const prayerMinutes = prayerOrder.map(prayer => {
        const [hours, minutes] = prayerTimes[prayer]?.split(':').map(Number) || [0, 0];
        return { name: prayer, minutes: hours * 60 + minutes };
      });

      let current = null;
      let next = null;

      for (let i = 0; i < prayerMinutes.length; i++) {
        const prayer = prayerMinutes[i];
        const nextPrayerIdx = (i + 1) % prayerMinutes.length;
        const nextPrayerTime = prayerMinutes[nextPrayerIdx];

        if (currentTime >= prayer.minutes && 
            (i === prayerMinutes.length - 1 || currentTime < prayerMinutes[i + 1].minutes)) {
          current = prayer.name;
          next = prayerMinutes[nextPrayerIdx].name;
          break;
        }
      }

      // Before Fajr
      if (!current && currentTime < prayerMinutes[0].minutes) {
        current = 'isha';
        next = 'fajr';
      }

      setCurrentPrayer(current);
      setNextPrayer(next || 'fajr');
    };

    updateCurrentPrayer();
    const interval = setInterval(updateCurrentPrayer, 60000);
    return () => clearInterval(interval);
  }, [prayerTimes]);

  // Toggle prayer completion
  const handleTogglePrayer = async (prayerName) => {
    const existingLog = prayerLogs.find(log => log.prayer_name === prayerName);
    
    if (existingLog) {
      await updateLogMutation.mutateAsync({
        id: existingLog.id,
        data: { completed: !existingLog.completed }
      });
    } else {
      await createLogMutation.mutateAsync({
        date: today,
        prayer_name: prayerName,
        completed: true,
        completed_on_time: true
      });
    }
  };

  // Mock weekly data (in a real app, you'd fetch this from the database)
  const weeklyData = [
    { completed: 5, total: 5 },
    { completed: 4, total: 5 },
    { completed: 5, total: 5 },
    { completed: 3, total: 5 },
    { completed: 5, total: 5 },
    { completed: Object.values(prayerLogsMap).filter(Boolean).length, total: 5 },
    { completed: 0, total: 5 }
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-emerald-50/30">
      <div className="max-w-6xl mx-auto px-4 py-6 md:py-10">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-8"
        >
          <h1 className="text-3xl md:text-4xl font-bold text-slate-800">
            Salah<span className="text-emerald-600">Time</span>
          </h1>
          <p className="text-slate-500 mt-1">Your daily prayer companion</p>
        </motion.div>

        {/* Main Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column */}
          <div className="lg:col-span-2 space-y-6">
            <NextPrayerBanner 
              nextPrayer={nextPrayer} 
              nextPrayerTime={prayerTimes[nextPrayer]}
            />
            
            <PrayerTimesCard 
              prayerTimes={prayerTimes}
              currentPrayer={currentPrayer}
              prayerLogs={prayerLogsMap}
              onTogglePrayer={handleTogglePrayer}
            />
            
            <WeeklyProgress weeklyData={weeklyData} />
          </div>

          {/* Right Column */}
          <div className="space-y-6">
            <IslamicDateCard />
            <QiblaCompass />
            <DailyDuaCard />
          </div>
        </div>

        {/* Footer */}
        <motion.footer
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5 }}
          className="mt-12 text-center text-slate-400 text-sm"
        >
          <p>بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</p>
          <p className="mt-1">In the name of Allah, the Most Gracious, the Most Merciful</p>
        </motion.footer>
      </div>
    </div>
  );
}